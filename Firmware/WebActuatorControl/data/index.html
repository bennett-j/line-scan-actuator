<!-- https://shawnhymel.com/1882/how-to-create-a-web-server-with-websockets-using-an-esp32-in-arduino/ -->


<!DOCTYPE HTML>
<html>

<head>
    <title>ESP Web Server</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" href="data:,">
    <link rel="stylesheet" type="text/css" href="style.css">
</head>

<body>
    <div class="topnav">
        <h1>ESP WebSocket Server</h1>
    </div>
    <div class="content">
        <div class="card">
            <h2>Output - GPIO 2</h2>
            <p class="state">state: <span id="state">%STATE%</span></p>
            <p><button id="button" class="button">Toggle</button></p>
        </div>
        <div>
            <h2>Setup Form</h2>
            <form onsubmit="formSubmit()">
                <label for="velocity">Velocity (mm/s):</label>
                <input type="number" id="velocity"><br>
                <label for="start_pos">Start Position (mm):</label>
                <input type="number" id="start_pos"><br>
                <label for="end_pos">End Position (mm):</label>
                <input type="number" id="end_pos"><br>
                <input type="submit" value="Submit">
            </form>
        </div>
        <div>
            <h2>Monitor</h2>
            <p class="mon">Status: <span id="status">---</span></p>
            <p class="mon">Velocity: <span id="m_vel">---</span></p>
            <p class="mon">Start Position: <span id="m_start">---</span></p>
            <p class="mon">End Position: <span id="m_end">---</span></p>
            <p class="mon">Current Position: <span id="m_pos">---</span></p>
        </div>
        <div>
            <h2>Actions</h2>
            <p><button id="home" onclick="click(home)" class="button">Home</button></p>
            <p><button id="goHome" onclick="click(goHome)" class="button">Go To Home</button></p>
            <p><button id="goStart" onclick="click(goStart)" class="button">Go To Start</button></p>
            <p><button id="start" onclick="click(start)" class="button">Start Scanning</button></p>
            <p><button id="stp" onclick="click(stp)" class="stop_button">Stop</button></p>
        </div>
    </div>
    <script>
        var gateway = `ws://${window.location.hostname}/ws`;
        var websocket;
        window.addEventListener('load', onLoad);
        function initWebSocket() {
            console.log('Trying to open a WebSocket connection...');
            websocket = new WebSocket(gateway);
            websocket.onopen = onOpen;
            websocket.onclose = onClose;
            websocket.onmessage = onMessage;
        }
        function onOpen(event) {
            console.log('Connection opened');
        }
        function onClose(event) {
            console.log('Connection closed');
            setTimeout(initWebSocket, 2000);
        }
        function onMessage(event) {
            console.log(event);
            
            // parse incoming message
            const msg = JSON.parse(event.data);

            if (msg.type == "report") {
                document.getElementById('status').innerHTML = msg.status;
                document.getElementById('m_vel').innerHTML = msg.m_vel;
                document.getElementById('m_start').innerHTML = msg.m_start;
                document.getElementById('m_stop').innerHTML = msg.m_stop;
            }
        }
        function onLoad(event) {
            initWebSocket();
            initButton();
        }
        function initButton() {
            document.getElementById('button').addEventListener('click', toggle);
        }
        function click(btn) {
            
            const msg = {
                type: "button",
                action: btn
            };

            console.log(msg);

            websocket.send(JSON.stringify(msg));
        }
        function formSubmit() {
            // https://developer.mozilla.org/en-US/docs/Web/API/WebSockets_API/Writing_WebSocket_client_applications
            // create msg containing form submission and send as JSON
            const msg = {
                type: "settings",
                velocity: document.getElementById("velocity").value,
                start_pos: document.getElementById("start_pos").value,
                end_pos: document.getElementById("end_pos").value
            };

            console.log(msg);

            websocket.send(JSON.stringify(msg));
            
            alert("form submitted");
        }
    </script>
</body>

</html>